<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Planner - Univille (LMS Editável)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        :root { --univille-blue: #083f0c; --univille-green: #008542; }

        .file-upload-wrapper {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #fff;
        }
        .file-upload-wrapper:hover { border-color: #008542; background-color: #f0fdf4; }

        .timeline-section { position: relative; padding-left: 24px; border-left: 2px solid #e2e8f0; margin-left: 12px; }
        .chevron-icon { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-[#083f0c] text-white shadow-lg sticky top-0 z-50 border-b-4 border-[#008542]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-white rounded-full p-1 w-10 h-10 flex items-center justify-center text-[#008542]">
                        <i class="fa-solid fa-graduation-cap text-2xl"></i>
                    </div>
                    <div>
                        <span class="font-bold text-lg tracking-tight block leading-none">Univille</span>
                        <span class="text-[#4caf50] text-xs font-light uppercase tracking-wider">Ambiente Virtual</span>
                    </div>
                </div>
                
                <div class="flex items-center bg-[#002d5c] rounded-lg p-1 border border-white/10 shadow-inner">
                    <button onclick="window.switchRole('professor')" id="btn-role-prof" class="px-4 py-1.5 text-xs font-bold rounded-md transition bg-[#008542] text-white shadow">Professor</button>
                    <button onclick="window.switchRole('student')" id="btn-role-student" class="px-4 py-1.5 text-xs font-bold rounded-md transition text-slate-300 hover:text-white">Aluno</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 gap-4 border-b border-slate-200 pb-6">
            <div>
                <span class="text-[#008542] font-bold text-sm uppercase tracking-wide mb-1 block">Disciplina</span>
                <h1 class="text-3xl font-extrabold text-[#002d5c]" id="page-title">Desenvolvimento Web</h1>
                <p class="text-slate-500 mt-1" id="page-subtitle">Prof. Exemplo | 2025/1</p>
            </div>
            
            <button id="btn-create" onclick="window.openModal('create')" class="bg-[#008542] hover:bg-[#006b35] text-white font-semibold py-2.5 px-6 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition duration-200 flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> Adicionar Conteúdo
            </button>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <div class="flex gap-2">
                <button onclick="window.filterTasks('all')" class="filter-btn active bg-[#002d5c] text-white px-4 py-1.5 rounded-lg text-sm font-medium transition shadow-sm" data-type="all">Tudo</button>
                <button onclick="window.filterTasks('activity')" class="filter-btn bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-1.5 rounded-lg text-sm font-medium transition" data-type="activity">Atividades</button>
                <button onclick="window.filterTasks('material')" class="filter-btn bg-slate-100 text-slate-600 hover:bg-slate-200 px-4 py-1.5 rounded-lg text-sm font-medium transition" data-type="material">Materiais</button>
            </div>
            
            <div class="flex items-center gap-3 w-full md:w-auto bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                <i class="fa-regular fa-calendar text-slate-400"></i>
                <input type="date" id="date-filter" onchange="window.renderTasks()" class="bg-transparent text-sm outline-none text-slate-600 w-full md:w-auto">
                <button onclick="document.getElementById('date-filter').value=''; window.renderTasks()" class="text-slate-400 hover:text-red-500" title="Limpar"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>

        <div id="content-container" class="space-y-6">
            </div>
        
        <div id="empty-state" class="hidden text-center py-16">
            <div class="bg-slate-100 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-layer-group text-4xl text-slate-300"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-600">Nenhum conteúdo publicado</h3>
        </div>

    </main>

    <div id="universal-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-[#002d5c] bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="window.closeModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block align-middle bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:max-w-2xl w-full">
                <div class="bg-[#008542] px-6 py-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2" id="modal-title">Novo Conteúdo</h3>
                    <button onclick="window.closeModal()" class="text-white/80 hover:text-white transition"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                
                <div class="bg-white px-6 py-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
                    
                    <form id="task-form">
                        <input type="hidden" id="task-id">
                        
                        <div id="professor-fields" class="hidden space-y-5">
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Organização</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-slate-700 text-sm font-bold mb-2">Bimestre</label>
                                        <select id="quarter" class="w-full border border-slate-300 rounded-lg py-2.5 px-3 bg-white">
                                            <option value="1º Bimestre">1º Bimestre</option>
                                            <option value="2º Bimestre">2º Bimestre</option>
                                            <option value="3º Bimestre">3º Bimestre</option>
                                            <option value="4º Bimestre">4º Bimestre</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-slate-700 text-sm font-bold mb-2">Aula / Tópico</label>
                                        <input id="lesson" type="text" list="lesson-suggestions" class="w-full border border-slate-300 rounded-lg py-2.5 px-3" placeholder="Ex: Aula 01 - Introdução">
                                        <datalist id="lesson-suggestions">
                                            <option value="Aula 01 - Introdução">
                                            <option value="Aula 02 - Fundamentos">
                                        </datalist>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Título</label>
                                    <input id="title" type="text" class="w-full border border-slate-300 rounded-lg py-2.5 px-3 focus:ring-2 focus:ring-[#008542]" required>
                                </div>
                                <div>
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Tipo</label>
                                    <select id="type" onchange="window.toggleGradeField()" class="w-full border border-slate-300 rounded-lg py-2.5 px-3 bg-white">
                                        <option value="material">Material</option>
                                        <option value="activity">Atividade</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">Descrição</label>
                                <textarea id="description" rows="3" class="w-full border border-slate-300 rounded-lg py-2.5 px-3"></textarea>
                            </div>

                            <div id="activity-settings" class="hidden bg-green-50 p-4 rounded-xl border border-green-200">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-slate-700 text-sm font-bold mb-2">Nota Máxima</label><input id="max-grade" type="number" class="w-full border border-slate-300 rounded-lg py-2 px-3" placeholder="10.0"></div>
                                    <div><label class="block text-slate-700 text-sm font-bold mb-2">Prazo</label><input id="date" type="date" class="w-full border border-slate-300 rounded-lg py-2 px-3"></div>
                                </div>
                                <div class="mt-4 flex gap-6">
                                    <label class="flex items-center text-sm font-medium text-slate-700"><input type="checkbox" id="allow-text" checked class="mr-2 text-[#008542]"> Permitir Texto</label>
                                    <label class="flex items-center text-sm font-medium text-slate-700"><input type="checkbox" id="allow-file" checked class="mr-2 text-[#008542]"> Permitir Arquivo</label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">Anexar Arquivo</label>
                                <div class="file-upload-wrapper relative group">
                                    <input type="file" id="prof-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="window.updateFileName('prof-file', 'prof-file-name')">
                                    <p id="prof-file-name" class="text-sm font-medium text-slate-500">Clique ou arraste para enviar</p>
                                </div>
                                <p class="text-xs text-slate-400 mt-1 italic hidden" id="edit-file-notice">* Se não enviar novo arquivo, o anterior será mantido.</p>
                            </div>
                        </div>

                        <div id="student-fields" class="hidden space-y-6">
                            
                            <div id="student-feedback-display" class="hidden bg-amber-50 border border-amber-200 rounded-xl p-5 shadow-sm">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="text-amber-900 font-bold flex items-center gap-2"><i class="fa-solid fa-check-double"></i> Correção Realizada</h4>
                                    <span class="bg-white text-amber-800 font-bold px-3 py-1 rounded border border-amber-100 text-lg shadow-sm" id="feedback-grade-badge">Nota: 10.0</span>
                                </div>
                                <p class="text-amber-800 text-sm italic" id="feedback-text-content">"Excelente trabalho..."</p>
                            </div>

                            <div id="prof-attachment-display" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-lg flex items-center justify-center"><i class="fa-solid fa-file-pdf text-xl"></i></div>
                                    <div><p class="text-sm font-bold text-blue-900">Material de Apoio</p><p class="text-xs text-blue-700" id="prof-attachment-name">arquivo.pdf</p></div>
                                </div>
                                <button type="button" class="text-blue-600 font-bold text-sm">Baixar</button>
                            </div>

                            <div id="student-text-area-container">
                                <label class="block text-slate-700 text-sm font-bold mb-2">Sua Resposta</label>
                                <textarea id="student-answer" rows="5" class="w-full border border-slate-300 rounded-lg py-3 px-4 bg-slate-50" placeholder="Escreva sua resposta aqui..."></textarea>
                            </div>

                            <div id="student-file-container">
                                <label class="block text-slate-700 text-sm font-bold mb-2">Anexar Trabalho</label>
                                <div class="file-upload-wrapper relative group">
                                    <input type="file" id="student-file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="window.updateFileName('student-file', 'student-file-name')">
                                    <p id="student-file-name" class="text-sm text-slate-500">Selecionar arquivo...</p>
                                </div>
                            </div>
                        </div>

                        <div id="grading-fields" class="hidden">
                            <div class="overflow-hidden rounded-xl border border-slate-200">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Aluno</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Entrega</th>
                                            <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Avaliação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="submissions-list" class="bg-white divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="mt-8 flex flex-row-reverse gap-3 pt-6 border-t border-slate-100" id="modal-footer">
                            <button type="button" onclick="window.handleFormSubmit()" id="btn-submit-modal" class="inline-flex justify-center rounded-lg shadow-md px-6 py-2.5 bg-[#008542] text-sm font-bold text-white hover:bg-[#006b35] transition">Confirmar</button>
                            <button type="button" onclick="window.closeModal()" class="inline-flex justify-center rounded-lg border border-slate-300 px-6 py-2.5 bg-white text-sm font-bold text-slate-700 hover:bg-slate-50 transition">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'univille_lms_v6_editable';
        let tasks = [];
        let currentRole = 'professor';
        let currentFilter = 'all';
        const CURRENT_STUDENT_NAME = "Você (Aluno)";
        let expandedSections = new Set();

        function loadTasks() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                tasks = JSON.parse(data);
            } else {
                tasks = [
                    { id: '1', quarter: '1º Bimestre', lesson: 'Aula 01 - Introdução', type: 'material', title: 'Slides de Apresentação', description: 'Conceitos básicos.', profAttachment: 'slide_intro.pdf', submissions: [] },
                    { id: '2', quarter: '1º Bimestre', lesson: 'Aula 02 - HTML5', type: 'activity', title: 'Exercício 1', description: 'Estrutura básica.', date: '2025-03-10', maxGrade: '10', allowText: true, allowFile: true, submissions: [{ studentName: CURRENT_STUDENT_NAME, text: 'Minha resposta...', file: null, grade: '9.5', feedback: 'Muito bom!' }] }
                ];
                saveTasks();
            }
            const firstQ = tasks.length > 0 ? tasks[0].quarter : null;
            if(firstQ) expandedSections.add(firstQ);
            renderTasks();
        }

        function saveTasks() { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); renderTasks(); }

        window.renderTasks = () => {
            const container = document.getElementById('content-container');
            const emptyState = document.getElementById('empty-state');
            const dateFilterVal = document.getElementById('date-filter').value;
            container.innerHTML = '';
            
            let filtered = tasks.filter(t => {
                const typeMatch = currentFilter === 'all' || t.type === currentFilter;
                const dateMatch = !dateFilterVal || t.date === dateFilterVal;
                return typeMatch && dateMatch;
            });

            if (filtered.length === 0) { emptyState.classList.remove('hidden'); return; } else { emptyState.classList.add('hidden'); }

            const groupedByQuarter = filtered.reduce((acc, task) => {
                const key = task.quarter || 'Geral';
                if (!acc[key]) acc[key] = [];
                acc[key].push(task);
                return acc;
            }, {});

            Object.keys(groupedByQuarter).sort().forEach(quarter => {
                const isExpanded = expandedSections.has(quarter);
                const quarterWrapper = document.createElement('div');
                quarterWrapper.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden";
                
                const header = document.createElement('div');
                header.className = "flex items-center justify-between p-5 cursor-pointer bg-slate-50 hover:bg-slate-100 transition select-none border-b border-slate-100";
                header.onclick = () => window.toggleSection(quarter);
                header.innerHTML = `<div class="flex items-center gap-3"><div class="w-2 h-8 bg-[#002d5c] rounded-full"></div><h2 class="text-xl font-bold text-[#002d5c]">${quarter}</h2><span class="text-xs font-semibold bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full">${groupedByQuarter[quarter].length} itens</span></div><i class="fa-solid fa-chevron-down text-slate-400 chevron-icon ${isExpanded ? 'rotate-180' : ''}"></i>`;

                const content = document.createElement('div');
                content.className = isExpanded ? "p-5 block fade-in" : "hidden";
                
                const tasksInQuarter = groupedByQuarter[quarter];
                tasksInQuarter.sort((a, b) => (a.lesson || '').localeCompare(b.lesson || ''));

                const groupedByLesson = tasksInQuarter.reduce((acc, task) => {
                    const key = task.lesson || 'Extras';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(task);
                    return acc;
                }, {});

                Object.keys(groupedByLesson).sort().forEach(lesson => {
                    const lessonBlock = document.createElement('div');
                    lessonBlock.className = "timeline-section mb-6 pb-2";
                    lessonBlock.innerHTML = `<div class="mb-3"><span class="inline-block px-2 py-1 rounded text-xs font-bold text-[#008542] bg-green-50 border border-green-100 uppercase tracking-wide">${lesson}</span></div>`;
                    const cardsDiv = document.createElement('div');
                    cardsDiv.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                    groupedByLesson[lesson].forEach(task => cardsDiv.appendChild(createTaskCard(task)));
                    lessonBlock.appendChild(cardsDiv);
                    content.appendChild(lessonBlock);
                });

                quarterWrapper.appendChild(header);
                quarterWrapper.appendChild(content);
                container.appendChild(quarterWrapper);
            });
        };

        window.toggleSection = (quarterName) => { if (expandedSections.has(quarterName)) expandedSections.delete(quarterName); else expandedSections.add(quarterName); renderTasks(); };

        function createTaskCard(task) {
            const isProf = currentRole === 'professor';
            const isActivity = task.type === 'activity';
            const icon = isActivity ? '<i class="fa-solid fa-clipboard-check text-green-600"></i>' : '<i class="fa-solid fa-book-open text-blue-600"></i>';
            const borderClass = isActivity ? 'border-l-green-500' : 'border-l-blue-400';
            const dateDisplay = task.date ? `<div class="text-xs text-slate-500 mt-2 font-medium bg-slate-50 inline-block px-2 py-1 rounded"><i class="fa-regular fa-clock"></i> Entrega: ${new Date(task.date).toLocaleDateString('pt-BR')}</div>` : '';

            let footerActions = '';
            let feedbackHtml = '';

            if (isProf) {
                const subCount = task.submissions ? task.submissions.length : 0;
                let gradeBtn = isActivity ? `<button onclick="window.openModal('grade', '${task.id}')" class="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded text-sm font-bold transition flex items-center gap-2"><i class="fa-solid fa-users-viewfinder"></i> Entregas <span class="bg-blue-100 text-blue-800 text-xs px-1.5 rounded-full">${subCount}</span></button>` : '';
                
                // Botões de Professor (Editar e Excluir)
                footerActions = `
                    <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center">
                        <div class="flex gap-2">
                            <button onclick="window.deleteTask('${task.id}')" class="text-slate-400 hover:text-red-500 text-sm p-1" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                            <button onclick="window.openModal('edit', '${task.id}')" class="text-slate-400 hover:text-[#002d5c] text-sm p-1" title="Editar"><i class="fa-solid fa-pen"></i></button>
                        </div>
                        ${gradeBtn}
                    </div>
                `;
            } else {
                if (isActivity) {
                    const mySub = task.submissions ? task.submissions.find(s => s.studentName === CURRENT_STUDENT_NAME) : null;
                    if (mySub && mySub.feedback) feedbackHtml = `<div class="mt-3 bg-amber-50 border border-amber-200 rounded-lg p-3 text-xs text-amber-900 shadow-sm"><span class="font-bold flex items-center gap-1 mb-1 text-amber-700"><i class="fa-regular fa-comment-dots"></i> Feedback:</span>"${mySub.feedback}"</div>`;
                    if (mySub) {
                        const grade = mySub.grade ? `<span class="text-[#002d5c] font-bold">Nota: ${mySub.grade}</span>` : '<span class="text-slate-400 italic">Em correção</span>';
                        footerActions = `<div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center"><button onclick="window.openModal('submit', '${task.id}')" class="text-green-600 text-xs font-bold flex items-center gap-1 hover:underline"><i class="fa-solid fa-circle-check"></i> Ver Entrega</button><span class="text-xs">${grade}</span></div>`;
                    } else {
                        footerActions = `<div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center"><span class="text-xs font-bold text-slate-400">Vale ${task.maxGrade} pts</span><button onclick="window.openModal('submit', '${task.id}')" class="bg-[#002d5c] hover:bg-[#001a36] text-white px-4 py-1.5 rounded text-sm font-bold shadow-sm">Entregar</button></div>`;
                    }
                } else {
                    footerActions = `<div class="mt-4 pt-3 border-t border-slate-100 flex justify-end"><button class="text-[#008542] hover:text-[#006b35] text-sm font-bold flex items-center gap-1">Acessar <i class="fa-solid fa-arrow-right"></i></button></div>`;
                }
            }

            const card = document.createElement('div');
            card.className = `bg-white rounded-lg shadow-sm border border-slate-200 p-5 hover:shadow-md transition duration-200 flex flex-col justify-between border-l-4 ${borderClass}`;
            card.innerHTML = `<div><div class="flex items-start justify-between mb-2"><h3 class="font-bold text-lg text-slate-800 leading-tight">${task.title}</h3><div class="bg-slate-50 p-2 rounded-lg text-lg">${icon}</div></div><p class="text-sm text-slate-600 mb-3">${task.description || ''}</p>${task.profAttachment ? `<div class="text-xs text-blue-600 mb-2 font-medium flex items-center gap-1"><i class="fa-solid fa-paperclip"></i> ${task.profAttachment}</div>` : ''}${dateDisplay}${feedbackHtml}</div>${footerActions}`;
            return card;
        }

        window.openModal = (mode, id = null) => {
            const modal = document.getElementById('universal-modal');
            const form = document.getElementById('task-form');
            const profFields = document.getElementById('professor-fields');
            const studFields = document.getElementById('student-fields');
            const gradeFields = document.getElementById('grading-fields');
            const title = document.getElementById('modal-title');
            const footer = document.getElementById('modal-footer');
            const feedbackDisplay = document.getElementById('student-feedback-display');
            const editNotice = document.getElementById('edit-file-notice');

            form.reset();
            document.getElementById('task-id').value = id || '';
            document.getElementById('prof-file-name').textContent = 'Clique ou arraste';
            document.getElementById('student-file-name').textContent = 'Selecionar arquivo...';

            profFields.classList.add('hidden');
            studFields.classList.add('hidden');
            gradeFields.classList.add('hidden');
            feedbackDisplay.classList.add('hidden');
            editNotice.classList.add('hidden');
            footer.classList.remove('hidden');
            modal.classList.remove('hidden');

            if (mode === 'create') {
                profFields.classList.remove('hidden');
                title.innerHTML = '<i class="fa-solid fa-plus"></i> Novo Conteúdo';
                window.toggleGradeField();
            } else if (mode === 'edit') {
                // MODO EDIÇÃO
                profFields.classList.remove('hidden');
                title.innerHTML = '<i class="fa-solid fa-pen"></i> Editar Conteúdo';
                editNotice.classList.remove('hidden'); // Avisa que se não subir arquivo, mantém o antigo
                
                // Preencher dados
                const task = tasks.find(t => t.id === id);
                document.getElementById('quarter').value = task.quarter;
                document.getElementById('lesson').value = task.lesson;
                document.getElementById('type').value = task.type;
                document.getElementById('title').value = task.title;
                document.getElementById('description').value = task.description;
                if(task.type === 'activity') {
                    document.getElementById('max-grade').value = task.maxGrade;
                    document.getElementById('date').value = task.date;
                    document.getElementById('allow-text').checked = task.allowText;
                    document.getElementById('allow-file').checked = task.allowFile;
                }
                if(task.profAttachment) {
                    document.getElementById('prof-file-name').textContent = `Atual: ${task.profAttachment} (Mudar?)`;
                    document.getElementById('prof-file-name').classList.add('text-blue-600', 'font-bold');
                }
                window.toggleGradeField();

            } else if (mode === 'submit') {
                studFields.classList.remove('hidden');
                title.innerHTML = '<i class="fa-solid fa-upload"></i> Detalhes da Entrega';
                const task = tasks.find(t => t.id === id);
                if(task.profAttachment) {
                    document.getElementById('prof-attachment-display').classList.remove('hidden');
                    document.getElementById('prof-attachment-name').textContent = task.profAttachment;
                } else { document.getElementById('prof-attachment-display').classList.add('hidden'); }
                
                document.getElementById('student-text-area-container').style.display = task.allowText ? 'block' : 'none';
                document.getElementById('student-file-container').style.display = task.allowFile ? 'block' : 'none';

                const mySub = task.submissions ? task.submissions.find(s => s.studentName === CURRENT_STUDENT_NAME) : null;
                if (mySub) {
                    document.getElementById('student-answer').value = mySub.text || '';
                    if(mySub.file) document.getElementById('student-file-name').textContent = mySub.file;
                    if (mySub.grade || mySub.feedback) {
                        feedbackDisplay.classList.remove('hidden');
                        document.getElementById('feedback-grade-badge').textContent = `Nota: ${mySub.grade || '-'}`;
                        document.getElementById('feedback-text-content').textContent = mySub.feedback ? `"${mySub.feedback}"` : "Sem comentários.";
                    }
                }
            } else if (mode === 'grade') {
                gradeFields.classList.remove('hidden');
                footer.classList.add('hidden');
                title.innerHTML = '<i class="fa-solid fa-check-double"></i> Correção';
                renderSubmissionsTable(id);
            }
        };

        window.closeModal = () => document.getElementById('universal-modal').classList.add('hidden');
        window.switchRole = (role) => { currentRole = role; document.getElementById('page-title').textContent = role === 'professor' ? "Painel do Professor" : "Área do Aluno"; renderTasks(); };
        window.toggleGradeField = () => { document.getElementById('activity-settings').classList.toggle('hidden', document.getElementById('type').value !== 'activity'); };
        window.updateFileName = (inputId, displayId) => { const i = document.getElementById(inputId); if(i.files[0]) document.getElementById(displayId).textContent = i.files[0].name; };

        function renderSubmissionsTable(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const tbody = document.getElementById('submissions-list');
            tbody.innerHTML = '';
            if(!task.submissions || task.submissions.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-slate-400">Nenhuma entrega.</td></tr>'; return; }
            task.submissions.forEach((sub, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-6 py-4"><div class="font-bold text-slate-700">${sub.studentName}</div></td><td class="px-6 py-4">${sub.text || ''} ${sub.file ? `(Arquivo: ${sub.file})` : ''}</td><td class="px-6 py-4"><div class="flex gap-2 mb-2"><input type="text" id="grade-${index}" value="${sub.grade || ''}" class="w-16 border rounded text-center"><button onclick="saveGrade('${taskId}', ${index})" class="bg-green-600 text-white px-2 rounded text-xs">OK</button></div><textarea id="feedback-${index}" class="w-full border rounded text-xs p-1">${sub.feedback || ''}</textarea></td>`;
                tbody.appendChild(tr);
            });
        }

        window.saveGrade = (taskId, index) => {
            const tIdx = tasks.findIndex(t => t.id === taskId);
            tasks[tIdx].submissions[index].grade = document.getElementById(`grade-${index}`).value;
            tasks[tIdx].submissions[index].feedback = document.getElementById(`feedback-${index}`).value;
            saveTasks();
            alert("Salvo!");
        };

        window.handleFormSubmit = () => {
            const id = document.getElementById('task-id').value;
            
            // Lógica Professor (Criar ou Editar)
            if (!document.getElementById('professor-fields').classList.contains('hidden')) {
                const fileInput = document.getElementById('prof-file');
                const taskIndex = tasks.findIndex(t => t.id === id);
                
                const taskData = {
                    quarter: document.getElementById('quarter').value,
                    lesson: document.getElementById('lesson').value,
                    type: document.getElementById('type').value,
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    maxGrade: document.getElementById('max-grade').value,
                    date: document.getElementById('date').value,
                    allowText: document.getElementById('allow-text').checked,
                    allowFile: document.getElementById('allow-file').checked,
                };

                if (taskIndex > -1) {
                    // EDITAR: Mantém ID, Submissões e Arquivo (se não houver novo)
                    const oldTask = tasks[taskIndex];
                    const newFileName = fileInput.files[0] ? fileInput.files[0].name : oldTask.profAttachment;
                    
                    tasks[taskIndex] = {
                        ...oldTask, // Mantém o que não mudou
                        ...taskData, // Sobrescreve campos do form
                        profAttachment: newFileName
                    };
                } else {
                    // CRIAR NOVO
                    tasks.push({
                        id: Date.now().toString(),
                        ...taskData,
                        profAttachment: fileInput.files[0] ? fileInput.files[0].name : null,
                        submissions: []
                    });
                }
            } else {
                // Lógica Aluno (Entrega)
                const tIdx = tasks.findIndex(t => t.id === id);
                const f = document.getElementById('student-file');
                const sub = { studentName: CURRENT_STUDENT_NAME, text: document.getElementById('student-answer').value, file: f.files[0]?.name, grade: '', feedback: '' };
                const exist = tasks[tIdx].submissions.findIndex(s => s.studentName === CURRENT_STUDENT_NAME);
                if(exist > -1) tasks[tIdx].submissions[exist] = { ...tasks[tIdx].submissions[exist], ...sub };
                else tasks[tIdx].submissions.push(sub);
            }
            saveTasks();
            window.closeModal();
        };
        
        window.deleteTask = (id) => { if(confirm("Excluir conteúdo?")) { tasks = tasks.filter(t => t.id !== id); saveTasks(); }};

        loadTasks();
    </script>
</body>
</html>